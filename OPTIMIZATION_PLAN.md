# PokerMaster Pro 优化计划

**创建日期：** 2026-02-16
**基于文档：** 《PokerMaster Pro 产品设计文档 V1.0》 + 《V2.0 Python Implementation》
**当前版本：** v0.1.0

---

## 一、手牌数据读取与管理模块

**现状：** 已有基础 CSV 解析和 SQLite 存储，支持导入和基础 CRUD。

### 1.1 数据清洗与异常标记
- [ ] 增加异常数据标记（只有盲注的手牌标记而非丢弃）
- [ ] 导入时生成数据质量报告（有效率、异常手牌数）

### 1.2 手牌库多条件筛选
- [ ] `HandRepository` 新增筛选方法：按日期、盲注级别、位置、盈亏组合查询
- [ ] Web 端手牌库页面增加多条件筛选栏
- [ ] 支持按"时间倒序/盈亏排序"

### 1.3 错题本/收藏系统
- [ ] 新增 `bookmarks` 表（hand_id, bookmark_type, notes, tags, error_grade, created_at）
- [ ] 新增 `BookmarkRepository`（收藏/取消、备注、标签管理）
- [ ] Web 端新增「错题本」页面（筛选 + 错误类型 + 错误等级标注）
- [ ] 支持复盘笔记的富文本编辑

### 1.4 数据导出
- [ ] 新增导出为 CSV/JSON 的方法
- [ ] Web 端增加导出按钮

### 1.5 导入与统计概览
- [ ] Web 端导入页面增加"历史导入记录报表"（导入时间、文件名、解析手数、有效率）
- [ ] 手牌库页面增加统计概览卡片（总手牌数、有效手牌数、近7天对局数、平均盈亏）
- [ ] 数据导入从侧边栏独立为「数据导入」子页面

**涉及文件：** `storage/schema.sql`, `storage/repository.py`, `web/pages/` 新增页面

---

## 二、多维度分析与弱点诊断模块

**现状：** 已有 10 项核心指标、GTO 基线对比、3 级漏洞检测。

### 2.1 新增指标
- [ ] `StatsCalculator` 新增 **ROI** 计算（total_profit / total_buyin * 100）
- [ ] `StatsCalculator` 新增 **WWSF%**（未摊牌赢率：won_without_showdown / saw_flop）
- [ ] `PositionalStats` 新增对应字段
- [ ] Web 端仪表盘展示新指标

### 2.2 S/A/B/C 四级错误定级
- [ ] `Severity` 枚举从 minor/moderate/major 改为 S/A/B/C 四级
- [ ] 定级规则：S级(偏差>15%, EV>5BB/100), A级(>10%, 3-5BB), B级(>5%, 1-3BB), C级(<5%, <1BB)
- [ ] 更新 `LeakDetector._create_leak()` 中的严重度判定逻辑
- [ ] 更新 Web 端 `2_leaks.py` 的展示样式（四级颜色 + 标签）
- [ ] 更新 CLI 和 `TableFormatter` 对应的显示

### 2.3 EV 损失量化
- [ ] 每个漏洞计算对应的 BB/100 损失估算
- [ ] `Leak` 数据类新增 `ev_loss_bb100` 字段
- [ ] 按 EV 损失排序，标注 Top3 核心短板
- [ ] Web 端弱点诊断页面展示 EV 损失排行

### 2.4 能力画像雷达图
- [ ] 定义 6 大维度：翻前技术、翻后攻击性、翻后防御、位置意识、摊牌能力、资金管理
- [ ] 每个维度计算综合评分（0-100）
- [ ] Web 端生成能力画像雷达图（与基准线对比）
- [ ] 支持训练前后画像对比

### 2.5 弱点诊断报告
- [ ] 生成结构化诊断报告（所有短板 + 错误统计 + 优化方向）
- [ ] 支持导出报告（Excel/PDF）

### 2.6 时间维度与基准线
- [ ] Web 端仪表盘支持按日/周/月维度切换数据
- [ ] GTO 基线从代码硬编码提取为 `config/baselines.json`（按盲注级别区分）
- [ ] 数据导入后自动触发指标重新计算

**涉及文件：** `analysis/leak_detector.py`, `analysis/calculator.py`, `models/stats.py`, `web/pages/1_stats.py`, `web/pages/2_leaks.py`, 新增 `config/baselines.json`

---

## 三、全场景智能复盘模块

**现状：** 已有 AI 单局复盘（Doubao API），功能较基础。

### 3.1 单局复盘增强
- [ ] 优化 Prompt：要求返回结构化 JSON（street_analysis, ev_comparison, optimal_play, error_explanation）
- [ ] 增加 GTO + 剥削型双策略建议
- [ ] 教练式语言输出（"这里你选择了XX，但更优的操作是YY，因为..."）
- [ ] 每个决策点的 EV 量化分析（弃牌/跟注/加注 EV 对比）
- [ ] 整局决策评分

### 3.2 批量复盘（新增）
- [ ] 新增 `analysis/batch_reviewer.py`
- [ ] 第一层：Pandas 本地统计（批次整体指标、错误分布）
- [ ] 第二层：筛选 EV 损失 Top 5-10 手牌，调用 Doubao API 深度分析
- [ ] 第三层：整合统计 + AI 分析，生成批次复盘报告
- [ ] Web 端新增「批量复盘」页面（选择手牌范围 → 进度 → 报告展示）

### 3.3 对局还原时间线
- [ ] Web 端单局复盘增加时间线可视化
- [ ] 按翻前-翻牌-转牌-河牌分步展示（公共牌、玩家动作、下注金额、底池）
- [ ] st.slider 模拟时间线拖拽，点击暂停查看决策点分析

### 3.4 复盘笔记
- [ ] 数据库新增 `review_notes` 表（hand_id, note_content, decision_point, created_at）
- [ ] Web 端增加 st.text_area 笔记编辑功能
- [ ] 笔记可关联具体决策点

### 3.5 分析结果缓存
- [ ] 新增 `analysis_results` 表（hand_id, analysis_type, ev_loss, error_grade, ai_explanation, created_at）
- [ ] 已分析手牌缓存结果，避免重复 API 调用
- [ ] 查询前先检查缓存

### 3.6 复盘记录管理
- [ ] Web 端新增「复盘记录」页面（展示历史复盘列表：复盘类型、时间、核心结论）
- [ ] 支持按类型、日期筛选
- [ ] 点击可重新查看复盘报告

### 3.7 复盘报告导出
- [ ] 支持导出为 Markdown 格式
- [ ] 可选导出为 PDF（python-docx / openpyxl）

**涉及文件：** `ai/prompts.py`, `ai/analyzer.py`, 新增 `analysis/batch_reviewer.py`, `storage/schema.sql`, Web 新增复盘中心页面

---

## 四、个性化专项训练模块

**现状：** 已有基础场景生成（从真实手牌提取 10+ 场景类型）和 AI 评估。

### 4.1 训练方案生成（新增）
- [ ] 新增 `training/plan_generator.py`
- [ ] 提取弱点 Top3 → 匹配对应训练模块（内置映射表）
- [ ] 生成个性化训练计划（训练模块、建议周期、每日时长、难度梯度）
- [ ] 数据库新增 `training_plans` 表
- [ ] Web 端新增「我的训练方案」页面

### 4.2 GTO 范围表内置
- [ ] 新增 `config/gto_ranges.json`（翻前 GTO 开池范围、3-Bet 范围，按位置区分）
- [ ] 翻前训练场景使用规则引擎匹配内置范围表
- [ ] 复杂场景（C-Bet、河牌价值下注）调用 Doubao API 生成

### 4.3 难度动态调整
- [ ] 训练过程中根据正确率自动升降难度
- [ ] 难度等级：初级 → 中级 → 高级 → 专家
- [ ] `ScenarioGenerator` 增加 difficulty 参数

### 4.4 训练效果验证
- [ ] 训练周期结束后，对比训练前后的核心指标变化
- [ ] 量化能力提升效果（VPIP 优化幅度、EV 损失减少量）
- [ ] 同步更新能力画像
- [ ] 若短板未改善 → 迭代训练方案

### 4.5 错题自动收录
- [ ] 训练错题自动关联至错题本（bookmarks 表）
- [ ] 支持重复训练错题

### 4.6 训练中心页面重组
- [ ] Web 端拆分为「我的训练方案」「专项训练库」「训练记录」3 个子页面
- [ ] 训练成长曲线（正确率、完成率变化）
- [ ] 模块完成进度展示

**涉及文件：** 新增 `training/plan_generator.py`, `config/gto_ranges.json`, `training/scenario.py`, `training/session.py`, `storage/schema.sql`, Web 训练中心页面

---

## 五、扩展辅助功能模块（全新）

### 5.1 GTO 策略库
- [ ] 内置常见场景 GTO 范围（JSON 配置）
- [ ] 按位置、筹码深度查询
- [ ] 复杂场景调用 Doubao API 补充
- [ ] Web 端新增「GTO 策略库」页面

### 5.2 对手分析
- [ ] Pandas 统计同桌对手核心指标
- [ ] 生成对手能力画像与打法风格标签
- [ ] Doubao API 生成剥削策略建议
- [ ] Web 端新增「对手分析」页面

### 5.3 下风期预警
- [ ] 规则引擎监测连续亏损 / 决策异常值
- [ ] 达到阈值触发预警提示
- [ ] 推送应对建议
- [ ] Web 端新增「下风期预警」页面

### 5.4 专业知识库
- [ ] Markdown 文件分类教学内容（基础规则、翻前策略、翻后技术、GTO 原理、资金管理）
- [ ] Streamlit 渲染展示，支持搜索
- [ ] 关联训练/复盘场景
- [ ] Web 端新增「专业知识库」页面

**涉及文件：** 新增 `analysis/opponent.py`, `analysis/downswing.py`, `config/gto_strategies/`, `knowledge/`, Web 新增辅助工具页面

---

## 六、Web UI / 导航架构重组

**现状：** 5 个页面 + 侧边栏导入，扁平结构。

### 6.1 导航结构重组
- [ ] 按产品文档改为 5 个一级模块：手牌管理、数据分析、复盘中心、训练中心、辅助工具
- [ ] 更新 `navigation.py` 菜单配置
- [ ] 子页面文件重新组织

### 6.2 页面新增/拆分清单
- [ ] 手牌管理：数据导入（从侧边栏独立）/ 手牌库 / 错题本
- [ ] 数据分析：数据仪表盘（四大看板）/ 弱点诊断
- [ ] 复盘中心：单局复盘 / 批量复盘 / 复盘记录
- [ ] 训练中心：我的训练方案 / 专项训练库 / 训练记录
- [ ] 辅助工具：GTO 策略库 / 对手分析 / 下风期预警 / 知识库

### 6.3 仪表盘增强
- [ ] 四大看板完整实现：全局概览、分维度指标、亏损分析、成长趋势
- [ ] 全局概览：核心指标卡片 + 趋势图（近30天）
- [ ] 分维度指标：翻前/翻后/高阶分类，与基准线对比（红色偏低/绿色偏高）
- [ ] 亏损分析：EV 损失 Top10 列表 + 高频错误类型饼图
- [ ] 成长趋势：能力评分雷达图 + 核心指标成长曲线

**涉及文件：** `web/navigation.py`, `web/pages/` 全部重组

---

## 七、数据库 Schema 变更汇总

```sql
-- 新增表
bookmarks         -- 错题本/收藏
analysis_results  -- AI 分析结果缓存
review_notes      -- 复盘笔记
training_plans    -- 训练方案
player_stats      -- 预计算的玩家统计
opponent_stats    -- 对手统计
```

- [ ] 编写 Schema 迁移脚本
- [ ] 更新 `storage/schema.sql`
- [ ] 新增对应的 Repository 类

---

## 八、实施优先级与排期

| 优先级 | 模块 | 工作量 | 状态 | 完成日期 |
|--------|------|--------|------|----------|
| **P0** | 2.2 S/A/B/C 四级定级 + 2.3 EV 损失量化 | 中 | ✅ **已完成** | 2026-02-16 |
| **P0** | 3.5 分析结果缓存表 + 3.2 批量复盘 | 大 | ✅ **已完成** | 2026-02-16 |
| **P1** | 1.2 手牌库多条件筛选 + 1.3 错题本系统 | 中 | ✅ **已完成** | 2026-02-16 |
| **P1** | 4.1 训练方案生成 + 4.3 难度调整 | 大 | ✅ **已完成** | 2026-02-16 |
| **P1** | 6.1 Web 导航重组 + 6.2 页面拆分 | 大 | ✅ **已完成** | 2026-02-16 |
| **P2** | 3.4 复盘笔记 | 小 | ✅ **已完成** | 2026-02-16 |
| **P2** | 2.4 能力画像雷达图 + 2.6 时间维度 | 中 | 未开始 | |
| **P2** | 3.3 对局还原时间线 + 3.4 复盘笔记 | 中 | 未开始 | |
| **P2** | 2.1 新增指标 (ROI/WWSF) | 小 | ✅ **已完成** | 2026-02-16 |
| **P3** | 5.1 GTO 策略库 + 5.2 对手分析 | 大 | 未开始 | |
| **P3** | 5.3 下风期预警 + 5.4 知识库 | 中 | 未开始 | |
| **P3** | 1.4 数据导出 + 3.7 报告导出 | 小 | 未开始 | |

---

## 每日进度记录

### 2026-02-16
- [x] 完成现有代码与产品文档的 Gap 分析
- [x] 生成优化计划文档
- [x] 选定起始模块，开始实施
- [x] P0-1: 完成 S/A/B/C 四级错误定级 + EV 损失量化
- [x] P0-2: 完成分析结果缓存 + 批量复盘功能（缓存已生效）
- [x] P1-1: 完成手牌库多条件筛选 + 错题本系统
- [x] P1-2: 完成训练方案生成 + 难度动态调整
- [x] P1-3: 完成 Web 导航重组 + 页面拆分
- [x] P2-2: 完成 3.4 复盘笔记功能
- [x] 额外完成: 新增 ROI/WWSF% 指标

---

*本文档随开发进度持续更新，每日记录完成项和新发现的问题。*
